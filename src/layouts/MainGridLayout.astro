---
import type { MarkdownHeading } from "astro";
import { Icon } from "astro-icon/components";

import { siteConfig } from "@/config";
import { BANNER_HEIGHT, MAIN_PANEL_OVERLAPS_BANNER_HEIGHT } from "@constants/constants";
import { widgetManager } from "@utils/widget-manager";
import BackToTop from "@components/backToTop.astro";
import Footer from "@components/footer.astro";
import Navbar from "@components/navbar.astro";
import SideBar from "@components/sidebar.astro";
import FullscreenWallpaper from "@components/fullscreenWallpaper.astro";
import Banner from "@components/banner.astro";
import IconifyLoader from "@components/common/iconifyLoader.astro";
import Layout from "./Layout.astro";
import "@styles/maingrid.css";

/**
 * Wallpaper
 */

interface Props {
    title?: string;
    banner?: string;
    description?: string;
    lang?: string;
    setOGTypeArticle?: boolean;
    postSlug?: string;
    headings?: MarkdownHeading[];
}

const {
    title,
    banner,
    description,
    lang,
    setOGTypeArticle,
    postSlug,
    headings = [],
} = Astro.props;
const hasBannerCredit = siteConfig.wallpaper.mode === "banner" && siteConfig.wallpaper.banner?.credit?.enable;
const hasBannerLink = !!siteConfig.wallpaper.banner?.credit?.url;

// 检查是否为首页
const isHomePage = Astro.url.pathname === "/" || Astro.url.pathname === "";

// 计算主内容区域位置
const mainPanelTop = siteConfig.wallpaper.mode === "banner"
    ? `calc(${BANNER_HEIGHT}vh - ${MAIN_PANEL_OVERLAPS_BANNER_HEIGHT}rem)`
    : "5.5rem";

// 当banner被禁用时，主内容区域应该始终从顶栏下面开始
const finalMainPanelTop = siteConfig.wallpaper.mode === "banner" ? mainPanelTop : "5.5rem";

// 检查是否应该启用半透明效果
const shouldEnableTransparency = siteConfig.wallpaper.mode === "banner" || siteConfig.wallpaper.mode === "fullscreen";

// 为组件添加半透明效果的CSS类
const transparentClass = shouldEnableTransparency ? "wallpaper-transparent" : "";

/**
 * SideBar
 */

// 检查侧边栏是否启用，动态调整网格布局
// 判断左右侧边栏是否有启用组件且具有实际内容
const hasLeftSidebar = widgetManager.hasContentOnSide("left", headings);
const hasRightSidebar = widgetManager.hasContentOnSide("right", headings);
// 响应式配置：不同设备上的侧边栏显示状态（只要任一侧存在组件且布局为 sidebar 即视为显示）
const mobileShowSidebar =
    (hasLeftSidebar || hasRightSidebar) &&
    widgetManager.shouldShowSidebar("mobile");
const tabletShowSidebar =
    (hasLeftSidebar || hasRightSidebar) &&
    widgetManager.shouldShowSidebar("tablet");
const desktopShowSidebar =
    (hasLeftSidebar || hasRightSidebar) &&
    widgetManager.shouldShowSidebar("desktop");

// 动态网格布局类名 - 根据左右侧边栏情况调整列宽
// 手机端：单列布局，主内容在上，侧栏在下
// 平板端：双列布局，左侧栏+右侧栏（上下堆叠）在左列，主内容在右列
// 桌面端：三列布局，左侧栏 | 主内容 | 右侧栏
const gridCols = `
    grid-cols-1
    ${
        tabletShowSidebar
            ? hasLeftSidebar || hasRightSidebar
                    ? "md:grid-cols-[17.5rem_1fr]"
                    : "md:grid-cols-1"
            : "md:grid-cols-1"
    }
    ${
        desktopShowSidebar
            ? hasLeftSidebar && hasRightSidebar
                ? "lg:grid-cols-[17.5rem_1fr_17.5rem]"
                : hasLeftSidebar
                    ? "lg:grid-cols-[17.5rem_1fr]"
                    : hasRightSidebar
                        ? "lg:grid-cols-[1fr_17.5rem]"
                        : "lg:grid-cols-1"
            : "lg:grid-cols-1"
    }
`
    .trim()
    .replace(/\s+/g, " ");

// 左侧侧边栏容器类名
// 手机端：显示在主内容下方
// 平板端：显示在左列第1行
// 桌面端：显示在第1列
const leftSidebarClass = `
    mb-0 col-span-1
    ${
        mobileShowSidebar && hasLeftSidebar
            ? "block row-start-2 row-end-3"
            : "hidden"
    }
    ${
        tabletShowSidebar && hasLeftSidebar
            ? "md:block md:max-w-[17.5rem]"
            : "md:hidden"
    }
    ${
        desktopShowSidebar && hasLeftSidebar
            ? "lg:block lg:max-w-[17.5rem] lg:col-start-1 lg:col-end-2 lg:row-start-1 lg:row-end-2"
            : "lg:hidden"
    }
`
    .trim()
    .replace(/\s+/g, " ");

// 右侧侧边栏容器类名
// 手机端：显示在左侧栏下方
// 平板端：显示在左列第2行（左侧栏下方）
// 桌面端：显示在第3列（右侧）
const rightSidebarClass = `
    mb-0 col-span-1
    ${
        mobileShowSidebar && hasRightSidebar
            ? "block row-start-3 row-end-4"
            : "hidden"
    }
    ${
        tabletShowSidebar && hasRightSidebar
            ? "md:block md:max-w-[17.5rem]"
            : "md:hidden"
    }
    ${
        desktopShowSidebar && hasRightSidebar
            ? hasLeftSidebar
                ? "lg:block lg:max-w-[17.5rem] lg:col-start-3 lg:col-end-4 lg:row-start-1 lg:row-end-2"
                : "lg:block lg:max-w-[17.5rem] lg:col-start-2 lg:col-end-3 lg:row-start-1 lg:row-end-2"
            : "lg:hidden"
    }
`
    .trim()
    .replace(/\s+/g, " ");

// 主内容区域类名
// 手机端：主内容在第1行
// 平板端：主内容在右列，纵向跨越所有侧栏行
// 桌面端：主内容在第2列
const mainContentClass = `
    overflow-hidden w-full
    col-span-1 row-start-1 row-end-2
    ${
        tabletShowSidebar
            ? hasLeftSidebar || hasRightSidebar
                ? "md:col-start-2 md:col-end-3 md:row-start-1 md:row-end-2"
                : "md:col-start-1 md:col-end-2 md:row-start-1 md:row-end-2"
            : "md:col-span-1"
    }
    ${
        desktopShowSidebar
            ? hasLeftSidebar && hasRightSidebar
                ? "lg:col-start-2 lg:col-end-3 lg:row-start-1 lg:row-end-2"
                : hasLeftSidebar
                    ? "lg:col-start-2 lg:col-end-3 lg:row-start-1 lg:row-end-2"
                    : hasRightSidebar
                        ? "lg:col-start-1 lg:col-end-2 lg:row-start-1 lg:row-end-2"
                        : "lg:col-span-1"
            : "lg:col-span-1"
    }
`
    .trim()
    .replace(/\s+/g, " ");
---

<Layout
    title={title}
    banner={banner}
    description={description}
    lang={lang}
    setOGTypeArticle={setOGTypeArticle}
    postSlug={postSlug}
>
    <!-- 全局图标加载器 -->
    <IconifyLoader />

    <!-- Navbar -->
    <slot slot="head" name="head" />
    <div
        id="top-row"
        class="z-50 pointer-events-none relative transition-all duration-600 max-w-[var(--page-width)] px-0 md:px-4 mx-auto"
        class:list={[""]}
    >
        <div
            id="navbar-wrapper"
            class="pointer-events-auto sticky top-0 transition-all"
        >
            <Navbar />
        </div>
    </div>

    <!-- 全屏壁纸 - 总是渲染但通过CSS控制可见性 -->
    <FullscreenWallpaper
        config={siteConfig.wallpaper}
        class={siteConfig.wallpaper.mode === "fullscreen" ? "" : "hidden"}
    />

    <!-- 为全屏壁纸模式添加body类 -->
    {
        shouldEnableTransparency && (
            <script>
                document.body.classList.add('wallpaper-transparent');
            </script>
        )
    }

    <!-- Banner - 总是渲染但通过CSS控制可见性 -->
    <Banner
        config={siteConfig.wallpaper}
        isHomePage={isHomePage}
        class={siteConfig.wallpaper.mode === "banner" ? "" : "hidden"}
    />

    <!-- Main content -->
    <div
        class={`absolute w-full z-30 pointer-events-none transition-all duration-600 ${siteConfig.wallpaper.mode !== "banner" ? "no-banner-layout" : ""} ${transparentClass}`}
        style={`top: ${finalMainPanelTop}`}
    >
        <div
            class="relative max-w-[var(--page-width)] mx-auto pointer-events-auto"
        >
            <div
                    id="main-grid"
                    class={`transition-all duration-600 w-full left-0 right-0 grid ${gridCols} grid-rows-[auto] mx-auto gap-4 px-0 md:px-4 ${!mobileShowSidebar ? "mobile-no-sidebar" : ""} ${(hasLeftSidebar || hasRightSidebar) ? "mobile-both-sidebar" : ""}`}
                >
                <!-- Banner image credit -->
                {
                    hasBannerCredit && (
                        <a
                            href={siteConfig.wallpaper.banner?.credit?.url}
                            id="banner-credit"
                            target="_blank"
                            rel="noopener"
                            aria-label="Visit image source"
                            class:list={[
                                "group onload-animation-up transition-all absolute flex justify-center items-center rounded-full " +
                                    "px-3 right-4 -top-[3.25rem] bg-black/60 hover:bg-black/70 h-9",
                                {
                                    "hover:pr-9 active:bg-black/80":
                                        hasBannerLink,
                                },
                            ]}
                        >
                            <Icon
                                class="text-white/75 text-[1.25rem] mr-1"
                                name="material-symbols:copyright-outline-rounded"
                            />
                            <div class="text-white/75 text-xs">
                                {siteConfig.wallpaper.banner?.credit?.text}
                            </div>
                            <Icon
                                class:list={[
                                    "transition absolute text-[oklch(0.75_0.14_var(--hue))] right-4 text-[0.75rem] opacity-0",
                                    {
                                        "group-hover:opacity-100":
                                            hasBannerLink,
                                    },
                                ]}
                                name="fa6-solid:arrow-up-right-from-square"
                            />
                        </a>
                    )
                }

                <div class="contents lg:contents md:flex md:flex-col md:col-start-1 md:row-start-1 md:gap-4">
                    {
                        (mobileShowSidebar ||
                            tabletShowSidebar ||
                            desktopShowSidebar) &&
                            hasLeftSidebar ? (
                                <SideBar
                                    id="left-sidebar"
                                    side="left"
                                    class={`${leftSidebarClass} ${transparentClass} onload-animation-up`}
                                    headings={headings}
                                />
                            ) : (
                                <div id="left-sidebar" class="hidden"></div>
                            )
                    }
                    {
                        (mobileShowSidebar ||
                            tabletShowSidebar ||
                            desktopShowSidebar) &&
                            hasRightSidebar ? (
                                <SideBar
                                    id="right-sidebar"
                                    side="right"
                                    class={`${rightSidebarClass} ${transparentClass} onload-animation-up`}
                                    headings={headings}
                                />
                            ) : (
                                <div id="right-sidebar" class="hidden"></div>
                            )
                    }
                </div>

                <main
                    id="swup-container"
                    class={`${mainContentClass} transition-swup-fade`}
                >
                    <div id="grid-class-carrier" data-grid-class={gridCols} class="hidden"></div>
                    <div
                        id="content-wrapper"
                        class="onload-animation-up transition-leaving"
                    >
                        <slot />
                        <div
                            class="footer col-span-2 onload-animation-up hidden lg:block transition-swup-fade"
                        >
                            <Footer />
                        </div>
                    </div>
                </main>

                <div class="footer col-span-2 onload-animation-up block lg:hidden transition-swup-fade">
                    <Footer />
                </div>
            </div>

            <BackToTop />
    </div>
</div>
</Layout>